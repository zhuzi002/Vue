<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>甘肃芒果专区</title>
<meta name="page-view-size" content="1280*720" />
<link type="text/css" rel="stylesheet" href="../css/styleExit.css" />
<style>
.l-popup .tit{
	position:absolute;
	left:70px; 
	top:250px;
}
.l-popup .tit,.l-popup .tit .pic,.l-popup .tit .pic img{
	width:463px; 
	height: 92px;
}
.l-popup .videoBox{
	position: absolute;
	left: 678px;
	top: 46px;
	width: 494px;
	height: 280px;
}
.l-popup .videoBox .item{
	width: 494px;
	height: 280px;
}
.l-popup .videoBox .item{
	width: 494px;
	height: 280px;
	background: url(../images/imagesExit/border.png) no-repeat;
}
.l-popup .videoBox .item_focus{
	background: url(../images/imagesExit/borderFocus.png) no-repeat;
}
.l-popup .videoBox .icon{
	width: 494px;
	height: 280px;
	background:url(../images/imagesExit/playBtn.png) no-repeat;
	z-index: 2; 
}
.l-popup .videoBox .pic,.l-popup .videoBox .pic img{
	width: 486px;
	height: 273px;
}
.l-popup .videoBox .pic{
	left: 4px;
	top: 4px;
}
.l-popup .closeBtn{
	position: absolute;
	left: 1210px;
	top: 10px;
	width: 54px;
	height: 54px;
}
.l-popup .closeBtn .item{
	width: 54px;
	height: 54px;
	background: url(../images/imagesExit/closeBtn.png) no-repeat; 
}
.l-popup .closeBtn .item_focus{
	background: url(../images/imagesExit/closeBtn_focus.png) no-repeat; 
}
.l-popup .itemList{
	position: absolute;
	left:0px; 
	top:335px;
	width: 1280px;
	height: 350px;
	overflow: hidden;
}
.scollBox{
	position: absolute;
}
.l-popup .itemList .item{
	width: 229px;
	height: 342px;
}
.l-popup .itemList .item_focus{
	background: url(../images/imagesExit/itemList_focus.png) no-repeat;
	z-index: 2;
}
.l-popup .itemList .item .pic,.l-popup .itemList .item .pic img{
	width: 160px;
	height: 239px;
}
.l-popup .itemList .item .pic,.l-popup .itemList .item .boxShadow{
	top: 55px;
}
.l-popup .itemList .item .boxShadow,.l-popup .itemList .item .boxShadow img{
	position: absolute;
	width: 160px;
	height: 239px;
}
.l-popup .itemList .item .txt{
	left: 5px;
	top: 262px;
	width: 150px;
	font-size: 22px;
	white-space: nowrap;
	overflow: hidden;
}
.l-popup .itemList .item_focus .pic,
.l-popup .itemList .item_focus .pic img,
.l-popup .itemList .item_focus .boxShadow,
.l-popup .itemList .item_focus .boxShadow img{
	width: 224px;
	height: 337px;
}
.l-popup .itemList .item_focus .pic,.l-popup .itemList .item_focus .boxShadow{
	top: 3px;
	left:2px;
}
.l-popup .itemList .item_focus .txt{
	left: 0px;
	top: 300px;
	width: 224px;
	height: 30px;
	font-size: 30px;
}
#nav2_5_txt{
	color: #e7e5ee;
	font-size: 22px;
	left: 25px;
	top: 235px;
	width: 440px;
	height: 26px;
	line-height: 26px;
	overflow: hidden;
}
/*#close_icon {*/
	/*position:absolute;*/
	/*top:23px;*/
	/*left:1195px;*/
/*}*/
/*#close_icon.item_focus{*/
	/*background: url(../images/imagesExit/closeBtn_focus.png) no-repeat;*/
	/*z-index: 2;*/
/*}*/
</style>
</head>
<body bgcolor="transparent">
<div class="wrapper"> 
	<!-- S pagebg -->
	<div id="test1" style="left: 20px; top: 20px; width: 800px; height: 300px; position: absolute; color: #ff0000; word-break:break-all;"></div>
	<div class="pagebg">
	  <div class="pic">
		  <img id="pagebg" src="" width="1280" height="720">

	  </div>
	</div>
	<!-- E pagebg --> 
</div>

<!-- S popup layer -->
<div class="l-popup">


	<div class="tit">
		<div class="pic">
			<img src="../images/imagesExit/titPic.png" alt="">
		</div>
	</div>
	<!--<div class="close_icon">-->
		<!--<div class="pic" id="close_icon">-->
			<!--<img src="../images/imagesExit/closeBtn.png" alt="">-->
		<!--</div>-->
	<!--</div>-->
	<!-- S videoBox -->
	<div class="videoBox">
		<div class="item" id="video">
			<div class="icon" id="videoIcon"></div>
			<div class="pic">
				<iframe id="smallvod" name="if_smallscreen" 
            		style="position: absolute; top: 0px;left: 0px; display: block;visibility: hidden;"
            		width="494" height="280"  src="" frameborder="no" scrolling="no" >
            	</iframe>
				<div class="txt" id="nav2_5_txt"></div>
			</div>
		</div>
	</div>
	<!-- E videoBox -->

	<!-- S closeBtn -->
	<!--<div class="closeBtn">
		<div class="item item_focus"></div>
	</div>-->
	<!-- E closeBtn -->

	<!-- S list -->
  
    <div class="itemList"> 
        <!--
                焦点: class="item item_focus"
            -->
	    <div class="scollBox" style="left: 100px;" id="cont_list">
	    
	    </div>
    </div>
    <!-- E list --> 
	
 </div>
<!-- E popup layer -->

</body>

<script src="../js/xepg.min.js"></script>
<script src="../js/commons.js"></script>
<!--<script src="../js/Util.js"></script>-->
<script type="text/javascript">

	var numUrl = (window.location.href).split("&result")[0] || window.location.href;
	var numUrl2 = decodeURIComponent(numUrl);
	var param = parseQueryString(numUrl2);  //URL解析成对象
    var currentId = 'cont_0'; //初始化焦点
	var g_contNum = 1;                //下侧列表推荐位内容个数
	var g_moveNum = parseInt(param.moveNum) || 0;     //列表偏移量
	var playNum = 0 ;   //当前播放位子
	var mp = null; //播放器对象
	var g_aContData = [];//存放下侧列表推荐位内容
	var contType = '';//推荐位的内容类型
	var g_backUrl = param.backUrl || '';//返回路径
	var parentId = '';//判断不容平台的code
	var recomendCodeList = '';//存放不同平台获取下侧列表推荐位code
	var recomendVoideList = '';//存放不同平台下获取视频推荐位code
	var contId = param.contid || '';   // 内容ID
	var contenttype = param.contenttype || 1;   //影片类型
	var pageIndex = param.pageIndex ||　1;  //当前页
	var videoNum = 1; //视频个数
	var idList = []; //储存所有播放内容ID
	var authCode = null;   //鉴权code
	var backUrl =  parseQueryString(numUrl).backUrl || '';
	var spPro = '';   //portalcode + sptoken 参数不同的平台的入口编码和临时身份
	var mgPartner = param.mgPartner || ''; //平台信息
	var mgUserID = param.mgUserID || '';  //用户ID
	var mgUserToken = param.mgUserToken || '';  //临时身份证明
	var mg_epginfo = '&mgPartner=' + mgPartner + '&mgUserID=' + mgUserID + '&mgUserToken=' + mgUserToken+ '&backUrl=' + backUrl;
	//音量加
	XEpg.Nav.key_volUp_event = function () {
		mp.setMuteFlag(0);  //0为有声， 1为静音
		nowVolume = mp.getVolume();
		nowVolume += 5;
		if (nowVolume >= 100) {
			nowVolume = 100;
		}
		mp.setVolume(nowVolume);
	};
	//音量减
	XEpg.Nav.key_volDown_event = function () {
		nowVolume = mp.getVolume();
		nowVolume -= 5;
		if (nowVolume <= 0) {
			nowVolume = 0;
			mp.setMuteFlag(1);
		}
		mp.setVolume(nowVolume);

	};
	//静音
	XEpg.Nav.key_volOver_event = function () {
		var muteFlag = mp.getMuteFlag();
		if (muteFlag == 1) {
			mp.setMuteFlag(0);
		} else {
			mp.setMuteFlag(1);
		}
	};
	window.onload = function () {
		if(mgPartner == 'ZTE2X'){  //中兴
			spPro = 'portalcode=2017gszx&sptoken=CF4EAB0D8DF1E71CA84762F6BA009BD4&';
			parentId = '5514';
		}else{  //华为catalogid
			spPro = 'portalcode=2017gshw&sptoken=96630FB882600EC4A3F0B610535FB2A7&';
			parentId = '5509';
		}
		//根据不同的平台获取不同的列表推荐位和视频推荐位
		if(parentId == '5514'){
			recomendCodeList = '5516';
			recomendVoideList = '5518';
		}
		if(parentId == '5509'){
			recomendCodeList = '5511';
			recomendVoideList = '5512';
		}
		getData.contList();
	};
	var getData = {
		contList : function () {  //获取下侧内容列表catalogid=5511(华为)
			XEpg.Util.ajaxGet("../ajax/getInterface2.jsp?action=getTagsData&"+ spPro +"pagesize=6&tmtype=2&orderinfo=1&pageindex=1&catelogid="+recomendCodeList ,function (obj) {//背景图
				var objs = XEpg.Util.parseJSON(obj);
				var bgPic = objs.result[0].icon_pc;
				$('pagebg').src = bgPic;
			});
					XEpg.Util.ajaxGet("../ajax/getInterface2.jsp?action=getIndexData&"+ spPro +"pagesize=6&tmtype=2&orderinfo=1&pageindex=1&catalogid="+recomendCodeList ,function (obj) {
				var m_data = XEpg.Util.parseJSON(obj);
				var m_item = m_data.result;
				g_contNum = m_item.length;
				for(var i = 0 ; i < g_contNum ; i ++){
					g_aContData.push(m_item[i])
				}
				getData.showData();
				getData.getVideoList();
			});
		},
		showData : function () {//显示下侧推荐位列表内容
			var m_aShowCont = [];
			for(var i = 0 ; i < g_contNum ; i++){
				var m_item = g_aContData[i];
				var m_name = (m_item.name).split('HD]')[1] || m_item.name;
				var recommendCode = m_item.catalogid.split(",")[0] || obj.result[0].catalogid;
				var m_zongyi = '';
				contType = m_item.categoryid;
				m_aShowCont.push(
					'<div id="cont_'+ i +'" class="item" style="left: '+ 173 * (i - g_moveNum) +'px;" title="'+contType+'&contid='+m_item.id+ '&contenttype=' + m_item.contenttype + '&recommendCode=' + recommendCode+'">',
						'<div class="pic"><img src="'+ m_item.midimg +'" ></div>',
						'<div class="boxShadow"><img src="../images/imagesExit/boxshadow.png" /></div>',
	                	'<div class="txt"  id="cont_'+ i +'_move">',
							'<span id="cont_'+ i +'_txt">' + m_name + '</span>', '<span id="cont_'+ i +'_copy"></span>',
						'</div>',
		            '</div>'
				);
				XEpg.$('cont_' + i).click({'func':click.c_cont})
					.down({'func':move.contUp})
					.up({'func':move.contUp})
					.right({'func':move.contRight})
					.left({'func' : move.contLeft})
					.focus({"func":textScroll})
					.blur({'func':clearTextStyle});
			}
			$('cont_list').innerHTML = m_aShowCont.join('');
			 //显示焦点
			XEpg.My.currentId = 'cont_0';
			$(XEpg.My.currentId).className = 'item item_focus';
			init();
		},
		getVideoList : function () {//获取上侧视频播放的列表内容catalogid=5512(华为)
			XEpg.Util.ajaxGet('../ajax/getInterface2.jsp?action=getIndexData&'+ spPro +'pagesize=5&tmtype=2&orderinfo=1&pageindex=1&catalogid='+recomendCodeList,function(obj){
				var data = XEpg.Util.parseJSON(obj);
				var list = data.result;
				videoNum = list.length;
				for(var i = 0 ; i < videoNum ; i ++){
					idList.push(list[i]);
				}
				codeNum =GetRandomNum(0 , (videoNum - 1)) || 0;
				getDetailCode(codeNum);
			});
		}
	};
	function getDetailCode (codeNum){
		var detailCode = idList[codeNum].id;
		var conentCode = null;
		XEpg.Util.ajaxGet('../ajax/getInterface2.jsp?action=getDetailData&'+ spPro +'tmtype=2&contentid=' + detailCode,function(data){
			var obj = XEpg.Util.parseJSON(data);
			var listData = obj.result[0];
			if(listData.subcontents != null){
				var subLen = listData.subcontents.length;
			}
			contenttype = listData.contenttype;
			var conType = listData.contenttype;
			if(conType == 1){
				playNum = 0;
				conentCode = listData.contentcode;  //单集
			}else{
				playNum =1;
				conentCode = listData.subcontents[subLen - 1].contentcode;  //有子集
			}
			$('video').title = 'contentId=' +  listData.id;
			contId = listData.id;
			getVideo(conentCode);
		})
	}
	function getVideo (conentCode) {
		if(mgPartner == 'ZTE2X'){  //中兴
			var epgdomain = Authentication.CTCGetConfig("EPGDomain" );
			var last = epgdomain.lastIndexOf("/");
			var host = epgdomain.substr( 0, last );
			var srcHost = host + "/MediaService/SmallScreen?" +
					"ContentID=" + conentCode + "&Left=678&Top=46&Width=494&Height=280&CycleFlag=0";

			document.getElementById("smallvod").src = srcHost;
			document.getElementById("videoIcon").style.display = "none";
			//document.getElementById("nav2_5_img").style.display = "none";
		}else{  //华为
			var epgdomain = Authentication.CTCGetConfig("EPGDomain");
			var srcHost = epgdomain.split("/EPG")[0] + "/EPG/MediaService/SmallScreen.jsp" +
					"?ContentID="+conentCode+"&Left=678&Top=46&Width=494&Height=280&CycleFlag=0";
			document.getElementById("smallvod").src = srcHost;
			document.getElementById("videoIcon").style.display = "none";
		}
		stopTimer = setTimeout(isStop, 2000);
	}
	function isStop (){
		var iframe = document.getElementById("smallvod");
		var epgdomain = Authentication.CTCGetConfig("EPGDomain");
		var iframeContent = (iframe.contentWindow || iframe.contentDocument);
		clearTimeout(stopTimer);
		if (mgPartner == 'ZTE2X') {
			try {
				mp = iframeContent.mymediaplayer; // 中兴获取Mediaplayer 对象
			} catch (e) {
			}
		} else {
			try {
				mp = iframeContent.mp; // 华为获取Mediaplayer 对象
			} catch (e) {
			}
		}
		if(mp){
			var endTimer = parseInt(mp.getMediaDuration(),10) * 1000;  //播放总时长
			var stopTime = null;   //结束当前视屏 播放下一个视频
			var nowVolume = 50 ;  //当前音量
			var stbid = Authentication.CTCGetConfig("STBType");
			var stbid2 = stbid.substring(0,6);
			if(stbid2 == 'IP906H'){
				mp.setAudioTrackUIFlag(0); //设置音轨的本地UI显示标志 0:不允许 1：允许
				mp.setMuteUIFlag(0); //设置静音的本地UI显示标志 0:不允许 1：允许
				mp.setAudioVolumeUIFlag(0); //设置音量调节本地UI的显示标志 0:不允许 1：允许
			}
			mp.playByTime(1, 600 , 1);
			if(endTimer > 600000){
				stopTime = 30000;
			}else{
				stopTime = endTimer;
			}
			if(stopTime){
				var Timer = setTimeout(function(){   //播放下一个视频
					destoryMP();
					if(codeNum == (videoNum - 1)){
						codeNum = 0;
					}else{
						codeNum ++ ;
					}
					clearTimeout(Timer);
					getDetailCode(codeNum);
				},stopTime)
			}
		}else{
			setTimeout(isStop, 2000);
		}
	}
    function GetRandomNum(Min,Max){//随机数
    	var Range = Max - Min;   
		var Rand = Math.random();   
		return(Min + Math.round(Rand * Range));   
    }
    function destoryMP() {///** 释放终端，停止视频播放*/
        var instanceId = mp.getNativePlayerInstanceID();
        mp.stop();
        mp.releaseMediaPlayer(instanceId);
    }
	function init () {
		XEpg.$('video').click({'func':click.getFullVideo}).down({'id':'cont_0'}).up({'id':'cont_0'});//视频推荐位焦点逻辑
		//XEpg.$('close_icon').click({'func':click.closePage}).left({'id':'video'}).right({'id':'video'}).up({'id':'video'}).down({'id':'video'});
	}
	var move = {
		contUp : function () {
			$(XEpg.My.currentId).className = 'item';
			clearTextStyle();
			XEpg.My.currentId = 'video';
			$(XEpg.My.currentId).className = 'item item_focus';
		},
		contRight : function () {
			var m_index = parseInt(XEpg.My.currentId.substring(5), 10);
			$(XEpg.My.currentId).className = 'item';
			clearTextStyle();
			if(g_contNum > 6){
				if((m_index - g_moveNum) === 5 ){
					g_moveNum ++;
					if((g_moveNum + 6) > g_contNum){
						g_moveNum = 0;
						XEpg.My.currentId = 'cont_0';
					}else{
						XEpg.My.currentId = 'cont_'+ (5 + g_moveNum);
					}
					for(var i = 0 ; i < g_contNum ; i ++){
						$('cont_' + i).style.left = ((i - g_moveNum) * 173) + 'px';
					}
				}else{
					XEpg.My.currentId = 'cont_' + (m_index + 1);
				}
			}else{
				if(m_index === (g_contNum - 1)){
					XEpg.My.currentId = 'cont_0';
				}else{
					XEpg.My.currentId = 'cont_' + (m_index + 1);
				}
			}
			textScroll();
			$(XEpg.My.currentId).className = 'item item_focus';
		},
		contLeft : function () {
			var m_index = parseInt(XEpg.My.currentId.substring(5), 10);
			$(XEpg.My.currentId).className = 'item';
			clearTextStyle();
			if(g_contNum > 6 && g_moveNum > 0){
				if((m_index - g_moveNum) === 0){
					g_moveNum --;
					XEpg.My.currentId = 'cont_'+ g_moveNum;
					for(var i = 0 ; i < g_contNum ; i ++){
						$('cont_' + i).style.left = ((i - g_moveNum) * 173) + 'px';
					}
				}else{
					XEpg.My.currentId = 'cont_' + (m_index - 1);
				}
			}else{
				if(m_index === 0){
					if(g_contNum > 6){
						XEpg.My.currentId = 'cont_5';
					}else{
						XEpg.My.currentId = 'cont_' + (g_contNum - 1);
					}
				}else{
					XEpg.My.currentId = 'cont_' + (m_index - 1);
				}
			}
			textScroll();
			$(XEpg.My.currentId).className = 'item item_focus';
		}
	};
	var click = {
		getFullVideo : function () {//全屏播放
			var backUrl = window.location.href.indexOf("?") > -1 ? window.location.href.substring(0, window.location.href.indexOf("?")) : window.location.href;
			backUrl +='?epg=gs&contid=' + contId  +'&currentId=' + XEpg.My.currentId  + '&contenttype=' + contenttype+ '&playNum=' + playNum + mg_epginfo+'&useAbled=1';

			XEpg.Util.gotoPage('play.html?returnUrl=' + encodeURIComponent(backUrl));
		},
		c_cont : function (){//下侧推荐位跳转
			var m_url = $(XEpg.My.currentId).title;
			var m_urlType = m_url.split('&')[0];
			var conIdCopy = m_url.split('&')[1];
			var contenttypeCopy = m_url.split('&')[2];
			var recommendCodeCopy = m_url.split('&')[3];
			if(m_urlType == 21){
				XEpg.Util.gotoPage('detail-zongyi.html?'+conIdCopy+'&useAbled=1&'+ contenttypeCopy+'&' + mg_epginfo);
			}else{
				XEpg.Util.gotoPage('detail-num.html?' + conIdCopy+ '&useAbled=1&' +contenttypeCopy+ '&'+recommendCodeCopy +'&'+mg_epginfo);
			}
		},
		closePage : function(){
			destoryMP();
			// 退出该专区
			var url = decodeURIComponent(param.backUrl);
			XEpg.Util.gotoPage(decodeURIComponent(url));
		}
	};
	// 保存当前页面信息
	function savePageInfo(){
		XEpg.SP.saveCurrentPageInfo('pageIndex',{
			'currentId' : XEpg.My.currentId,
			'moveNum' : g_moveNum,
			'backUrl' : encodeURIComponent(g_backUrl)
		});
	}
	function parseQueryString(url) {
		var json = {};
		var arr = url.substr(url.indexOf('?') + 1).split('&');
		arr.forEach(function(item) {
			var tmp = item.split('=');
			json[tmp[0]] = tmp[1];
		});
		return json;
	}
	//返回按钮事件
	XEpg.Nav.key_back_opt = function(){
		var url = decodeURIComponent(param.backUrl);
		XEpg.Util.gotoPage(decodeURIComponent(url));
	};
	//通多id获取dom节点
	function $(id){
		return document.getElementById(id);
	}
	//文字跑马灯开始
	var moveObj = null, scrollTimer = null, txtObj = null;
	function textScroll(){
		var m_conId = 'cont_';
		document.getElementById(XEpg.My.currentId).className = 'item item_focus';
		var m_index1 = parseInt(XEpg.My.currentId.substring(5) , 10);
		moveObj = document.getElementById(m_conId + m_index1 + '_move');
		txtObj = document.getElementById(m_conId + m_index1 + '_txt');

		if( moveObj.scrollWidth > moveObj.offsetWidth ){
			document.getElementById(m_conId + m_index1 + '_copy').innerHTML =  '　    ' + txtObj.innerHTML;
			startScroll();//父元素向左循环移动(设置父元素scrollleft)
		}
	}
	function startScroll(){//开始文字滚动
		if(moveObj.scrollLeft >= (txtObj.offsetWidth + 23) ){
			moveObj.scrollLeft = 0;
		}else {
			moveObj.scrollLeft +=2;
		}
		scrollTimer = setTimeout(startScroll, 50);
	}
	function clearTextStyle(){//清除文字滚动
		var m_conId = 'cont_';
		clearTimeout(scrollTimer);		//清除定时器
		document.getElementById(XEpg.My.currentId).className = 'item';
		var m_index1 = parseInt(XEpg.My.currentId.substring(5) , 10);
		var copyEle = document.getElementById(m_conId + m_index1 + '_copy');
		if(copyEle){//清空复制的滚动文字
			copyEle.innerHTML = '';
		}
		if(moveObj){//清空scrollLeft
			moveObj.scrollLeft = 0;
		}
	}
	//首次进入上报
//	function setLogInfo(){
//		var log_info = '{"action_type":"browsing","user_id":"' + g_userId + '","user_group_id":"1","epg_group_id":"2","terminal_type":"linux_STB","sys_id":"t","page_id":"biz_47315954","page_name":"高清芒果挽留页","refer_page_id":"biz_46494736","refer_pos_id":"","log_time":"' + Util.getTimeStamp() + '","refer_type":"3"}';
//		var url = 'http://125.88.98.41:8082/?opt=put&userid=' + g_userId + '&data=' + encodeURI(log_info);
//		XEpg.Util.ajaxGet(url,function(){});
//	}
</script>
</html>
